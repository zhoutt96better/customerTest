version: 0.1             
component: build
timeoutInSeconds: 1000
shell: bash           

env:
 
  # exportedVariables are made available to use as parameters in sucessor Build Pipeline stages
  # For this Build to run, the Build Pipeline needs to have a BUILDRUN_HASH parameter set
  exportedVariables:
    - TAG

# Its a native way to fetch artifacts from external or artifact repo or a file path to use before a stage.
# More about buildspec formats - https://docs.oracle.com/en-us/iaas/Content/devops/using/build_specs.htm

steps:
   - type: Command
     name: "Conseguir logo actualizado"
     command: |
      echo "la variable imagen_editada tiene el valor:"
      echo ${IMAGEN_EDITADA}     
      echo  ${OCI_PRIMARY_SOURCE_COMMIT_HASH}
      git diff-tree --no-commit-id --name-only -r ${OCI_PRIMARY_SOURCE_COMMIT_HASH}
      files=$(git diff-tree --no-commit-id --name-only -r ${OCI_PRIMARY_SOURCE_COMMIT_HASH})
      #recorreremos estos archivos modificados, y en caso de que pertenezcan a la carpeta zones guardamos su nombre.
      for file in $files
      do
        echo $file
        if [[ $file == *"todos_logos"* ]]; then
          foto= basename $file
          echo "guardar la variable foto en la IMAGEN_EDITADA"
          echo " la variable foto: "$foto
          IMAGEN_EDITADA=$foto
        fi    
      done
      echo "la variable imagen_editada despues de buscar el ultimo editado:"
      echo ${IMAGEN_EDITADA}
      
   - type: Command
     name: "Subir artefacto"
     command: |
      oci devops deploy-artifact create-generic-artifact --argument-substitution-mode NONE --artifact-path todos_logos/${IMAGEN_EDITADA}.png --artifact-type GENERIC_FILE --artifact-version 0.2 --project-id ocid1.devopsproject.oc1.eu-frankfurt-1.amaaaaaagmaryayaxj5e5675s2vcp6qqo7ndpcuupe56y6r5t3s3gx3qwccq --repository-id ocid1.artifactrepository.oc1.eu-frankfurt-1.0.amaaaaaagmaryaya33ygtslaxjbnvwrrql5azrkozka5sb4fzvpynjirf5ua --display-name ${IMAGEN_EDITADA}



